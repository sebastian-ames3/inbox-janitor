{% extends "base.html" %}

{% block title %}Activity Log - Inbox Janitor{% endblock %}

{% block content %}
<section class="py-8 sm:py-12">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Page Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Activity Log</h1>
            <p class="text-gray-600">Review all actions taken on your emails (last 30 days)</p>
        </div>

        <!-- Summary Stats -->
        <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-8">
            <div class="card text-center">
                <p class="text-sm text-gray-600 mb-1">Total Actions</p>
                <p class="text-2xl font-bold text-gray-900">{{ stats.total }}</p>
            </div>
            <div class="card text-center">
                <p class="text-sm text-gray-600 mb-1">Archived</p>
                <p class="text-2xl font-bold text-primary-600">{{ stats.archived }}</p>
            </div>
            <div class="card text-center">
                <p class="text-sm text-gray-600 mb-1">Trashed</p>
                <p class="text-2xl font-bold text-danger-600">{{ stats.trashed }}</p>
            </div>
            <div class="card text-center">
                <p class="text-sm text-gray-600 mb-1">Undone</p>
                <p class="text-2xl font-bold text-warning-600">{{ stats.undone }}</p>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-6" x-data="{ expanded: false }">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-900">Filters</h2>
                <button
                    @click="expanded = !expanded"
                    class="text-sm text-primary-600 hover:text-primary-700"
                >
                    <span x-text="expanded ? 'Hide' : 'Show'"></span>
                </button>
            </div>

            <div x-show="expanded" x-transition class="mt-4 space-y-4">
                <form action="/audit" method="get" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <!-- Action Type Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Action Type</label>
                        <select name="action_filter" class="form-select w-full rounded-md border-gray-300">
                            <option value="">All Actions</option>
                            <option value="archive" {% if action_filter == 'archive' %}selected{% endif %}>Archive</option>
                            <option value="trash" {% if action_filter == 'trash' %}selected{% endif %}>Trash</option>
                            <option value="keep" {% if action_filter == 'keep' %}selected{% endif %}>Keep</option>
                            <option value="undo" {% if action_filter == 'undo' %}selected{% endif %}>Undo</option>
                        </select>
                    </div>

                    <!-- Search -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                        <input
                            type="text"
                            name="search"
                            value="{{ search }}"
                            placeholder="Sender or subject..."
                            class="form-input w-full rounded-md border-gray-300"
                        >
                    </div>

                    <!-- Submit -->
                    <div class="flex items-end">
                        <button type="submit" class="btn btn-primary w-full">
                            Apply Filters
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Activity Table -->
        <div class="card overflow-hidden">
            {% if actions %}
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Date
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    From
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Subject
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Action
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Confidence
                                </th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for action in actions %}
                            <tr class="hover:bg-gray-50" id="action-{{ action.id }}">
                                <td class="px-4 py-3 text-sm text-gray-500 whitespace-nowrap">
                                    {{ action.created_at.strftime('%b %d, %I:%M %p') }}
                                </td>
                                <td class="px-4 py-3 text-sm text-gray-900">
                                    <div class="truncate max-w-xs" title="{{ action.from_address }}">
                                        {{ action.from_address }}
                                    </div>
                                </td>
                                <td class="px-4 py-3 text-sm text-gray-700">
                                    <div class="truncate max-w-md" title="{{ action.subject }}">
                                        {{ action.subject or '(No subject)' }}
                                    </div>
                                    {% if action.snippet %}
                                    <p class="text-xs text-gray-500 truncate mt-1">{{ action.snippet }}</p>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-3 text-sm whitespace-nowrap">
                                    {% if action.undone_at %}
                                        <span class="badge badge-warning">Undone</span>
                                    {% elif action.action == 'archive' %}
                                        <span class="badge badge-primary">Archived</span>
                                    {% elif action.action == 'trash' %}
                                        <span class="badge badge-danger">Trashed</span>
                                    {% elif action.action == 'keep' %}
                                        <span class="badge badge-success">Kept</span>
                                    {% else %}
                                        <span class="badge">{{ action.action }}</span>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-3 text-sm text-gray-700 whitespace-nowrap">
                                    {% if action.confidence %}
                                        <div class="flex items-center space-x-2">
                                            <div class="w-16 bg-gray-200 rounded-full h-2">
                                                <div
                                                    class="h-2 rounded-full {% if action.confidence >= 0.85 %}bg-success-600{% elif action.confidence >= 0.55 %}bg-primary-600{% else %}bg-warning-600{% endif %}"
                                                    style="width: {{ (action.confidence * 100)|int }}%"
                                                ></div>
                                            </div>
                                            <span class="text-xs text-gray-600">{{ (action.confidence * 100)|int }}%</span>
                                        </div>
                                    {% else %}
                                        <span class="text-xs text-gray-400">N/A</span>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-3 text-sm text-right whitespace-nowrap">
                                    {% if action.can_undo_until and action.can_undo_until > now and not action.undone_at %}
                                        <button
                                            onclick="undoAction('{{ action.id }}')"
                                            class="text-primary-600 hover:text-primary-700 text-sm font-medium"
                                        >
                                            Undo
                                        </button>
                                    {% else %}
                                        <span class="text-xs text-gray-400">—</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                {% if total_pages > 1 %}
                <div class="px-4 py-3 bg-gray-50 border-t border-gray-200 flex items-center justify-between">
                    <div class="text-sm text-gray-700">
                        Showing {{ ((page - 1) * per_page) + 1 }} to {{ min(page * per_page, total_actions) }} of {{ total_actions }} actions
                    </div>
                    <div class="flex space-x-2">
                        {% if page > 1 %}
                        <a href="?page={{ page - 1 }}{% if action_filter %}&action_filter={{ action_filter }}{% endif %}{% if search %}&search={{ search }}{% endif %}" class="btn btn-secondary text-sm">
                            Previous
                        </a>
                        {% endif %}

                        <span class="px-3 py-2 text-sm text-gray-700">
                            Page {{ page }} of {{ total_pages }}
                        </span>

                        {% if page < total_pages %}
                        <a href="?page={{ page + 1 }}{% if action_filter %}&action_filter={{ action_filter }}{% endif %}{% if search %}&search={{ search }}{% endif %}" class="btn btn-secondary text-sm">
                            Next
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            {% else %}
                <!-- Empty State -->
                <div class="text-center py-12">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No activity yet</h3>
                    <p class="mt-1 text-sm text-gray-500">
                        {% if action_filter or search %}
                            No actions match your filters.
                            <a href="/audit" class="text-primary-600 hover:text-primary-700">Clear filters</a>
                        {% else %}
                            When we process emails, you'll see the activity here.
                        {% endif %}
                    </p>
                </div>
            {% endif %}
        </div>

        <!-- Help Section -->
        <div class="mt-8 bg-primary-50 border border-primary-200 rounded-lg p-4">
            <div class="flex items-start space-x-3">
                <svg class="w-5 h-5 text-primary-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                </svg>
                <div class="text-sm text-primary-800">
                    <p class="font-medium mb-1">About the Activity Log</p>
                    <ul class="list-disc list-inside space-y-1 text-primary-700">
                        <li>Shows the last 30 days of email actions</li>
                        <li>You can undo any action within 30 days</li>
                        <li>Confidence scores show how certain we were about each decision</li>
                        <li>Undone actions restore emails to their original location</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Toast Container -->
<div id="toast-container" class="fixed bottom-4 right-4 z-50"></div>

<script>
    // Undo action
    async function undoAction(actionId) {
        const confirmed = confirm('Undo this action? The email will be restored to its original location.');
        if (!confirmed) return;

        const csrfToken = document.cookie.split('csrf_token=')[1]?.split(';')[0];

        try {
            const response = await fetch(`/api/actions/${actionId}/undo`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                }
            });

            if (response.ok) {
                window.showToast('Action undone successfully', 'success');

                // Update row to show undone state
                const row = document.getElementById(`action-${actionId}`);
                if (row) {
                    const actionCell = row.querySelector('td:nth-child(4)');
                    actionCell.innerHTML = '<span class="badge badge-warning">Undone</span>';

                    const actionsCell = row.querySelector('td:nth-child(6)');
                    actionsCell.innerHTML = '<span class="text-xs text-gray-400">—</span>';
                }
            } else {
                const data = await response.json();
                window.showToast(data.detail || 'Failed to undo action', 'error');
            }
        } catch (error) {
            window.showToast('Network error. Please try again.', 'error');
        }
    }
</script>
{% endblock %}
